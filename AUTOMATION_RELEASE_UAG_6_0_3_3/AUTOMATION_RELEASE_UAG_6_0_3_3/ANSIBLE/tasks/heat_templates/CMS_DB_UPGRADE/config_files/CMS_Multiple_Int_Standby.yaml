# Mavenir CMS Cloud Deployment version 1.2
heat_template_version: '2014-10-16'
#heat_template_version: 2014-10-16

description: This template deploys a CMS setup.

parameters:

### Confd Username
  confd_user:
    type: string
    description: CMS Confd User name.

### Confd Username Password
  confd_user_passwd:
    type: string
    description: CMS Confd User Password.

### Permit Root Login true/false
  ROOT_LOGIN_DISABLED:
    type: string
    description: CMS ROOT Login

### Local Authentication
  localAuthentication:
    type: string
    description: Local Authentication

###  Glance Images UUID
  CMS_image_name:
    type: string
    label: CMS Image
    description: CMS Glance Image name.

### Confd_mOne_KeybasedConnection 
  Confd_mOne_KeybasedConnection:
    type: string
    label: Confd_mOne_KeybasedConnection
    description: Confd mOne KeybasedConnection

### Confd_dsc_KeybasedConnection 
  Confd_dsc_KeybasedConnection:
    type: string
    label: Confd_dsc_KeybasedConnection
    description: Confd DSC KeybasedConnection

### Confd_vnfm_KeybasedConnection 
  Confd_vnfm_KeybasedConnection:
    type: string
    label: Confd_vnfm_KeybasedConnection
    description: Confd VNFM KeybasedConnection

### HA_MODE 
  Ha_Enabled:
    type: string
    label: Checking_for_HA_Enabled_or_Not 
    description: Checking for HA Enabled or Not

### Flavor
  CMS_flavor_name:
    type: string
    label: Flavor
    description: CMS VM  instance nova flavor.

## VM Name
  CMS_names:
    type: comma_delimited_list
    description: VM Name for the resource.

### OAM Network UUID
  oam_net_id:
    type: string
    label: OAM ipv4 network ID
    description: Neutron UUID for oam traffic.

### Fixed IPs for Instances
  CMS_oam_ips:
    type: comma_delimited_list
    description: Fixed IP assignments for CMS VMs on OAM network

### DB Network UUID
  db_net_id:
    type: string
    label: DB ipv4 network ID
    description: Neutron UUID for db traffic.

### Fixed IPs for Instances
  CMS_db_ips:
    type: comma_delimited_list
    description: Fixed IP assignments for CMS VMs on DB network

### VNF Network UUID
  vnf_net_id:
    type: string
    label: VNF ipv4 network ID
    description: Neutron UUID for VNF traffic.

### Fixed IPs for Instances
  CMS_vnf_ips:
    type: comma_delimited_list
    description: Fixed IP assignments for CMS VMs on VNF network

### VNFM Network UUID
  vnfm_net_id:
    type: string
    label: VNFM ipv4 network ID
    description: Neutron UUID for VNFM traffic.

### Fixed IPs for Instances
  CMS_vnfm_ips:
    type: comma_delimited_list
    description: Fixed IP assignments for CMS VMs on VNFM network

  CMS_DB_Active_Stadby_IPs:
    type: comma_delimited_list
    description: Fixed IP assignments for CMS VMs on DB network

  CMS_OAM_Active_Stadby_IPs:
    type: comma_delimited_list
    description: Fixed IP assignments for CMS VMs on OAM network

resources:
 
  CMS_1_oam_net_0_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param: oam_net_id }
      name: CMS_1_oam_net_0_port
      fixed_ips: 
          - { "ip_address": {get_param: [CMS_oam_ips, 0] }}

  CMS_1_db_net_1_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param: db_net_id }
      name: CMS_1_db_net_1_port
      fixed_ips: 
          - { "ip_address": {get_param: [CMS_db_ips, 0] }}

  CMS_1_vnf_net_2_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param: vnf_net_id }
      name: CMS_1_vnf_net_2_port
      fixed_ips: 
          - { "ip_address": {get_param: [CMS_vnf_ips, 0] }}

  CMS_1_vnfm_net_3_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param: vnfm_net_id }
      name: CMS_1_vnfm_net_3_port
      fixed_ips: 
          - { "ip_address": {get_param: [CMS_vnfm_ips, 0] }}

  CMS_1:
    type: OS::Nova::Server
    properties:
      name: { get_param:  [CMS_names, 0]  }
      metadata:
         metering.stack: {get_param: "OS::stack_id"}
      flavor: { get_param: CMS_flavor_name }
      image: { get_param: CMS_image_name }
      networks:
        - port: { get_resource: CMS_1_oam_net_0_port }
        - port: { get_resource: CMS_1_db_net_1_port }
        - port: { get_resource: CMS_1_vnf_net_2_port }
        - port: { get_resource: CMS_1_vnfm_net_3_port }
      config_drive: true
      user_data_format: RAW
      user_data:
        str_replace:
           template: |
                #mavenirdata:
                network:
                  # eth0
                  CMS_1_oam_net_0_port:
                    TYPE: Ethernet
                    IFNAME: eth0
                    IPADDR: $OAMIP
                    PREFIX: $OAMPF
                    DEFAULTGW: yes
                    GATEWAY: $OAMGW
                    MTU: 1500

                  # eth1
                  CMS_1_db_net_1_port:
                    TYPE: Ethernet
                    IFNAME: eth1
                    IPADDR: $DBIP
                    PREFIX: $DBPF
                    GATEWAY: $DBGW
                    MTU: 1500

                  # eth2
                  CMS_1_vnf_net_2_port:
                    TYPE: Ethernet
                    IFNAME: eth2
                    IPADDR: $VNFIP
                    PREFIX: $VNFPF
                    GATEWAY: $VNFGW
                    MTU: 1500

                  # eth3
                  CMS_1_vnfm_net_3_port:
                    TYPE: Ethernet
                    IFNAME: eth3
                    IPADDR: $VNFMIP
                    PREFIX: $VNFMPF
                    GATEWAY: $VNFMGW
                    MTU: 1500
                vdu:
                  security:
                    CONFD_USERNAME: confd_user
                    CONFD_PASSWORD: confd_user_passwd
                    LDAP_SERVER1: "ldaps://10.10.72.122:636"
                    LDAP_SERVER2: "ldaps://10.10.72.123:636"
                    LDAP_SERVER3: "ldaps://10.10.72.124:636"
                    LDAP_SERVER4: "ldaps://10.10.72.125:636"
                    LDAP_BASEDN: "dc=mavenir,dc=com"
                    LDAP_USER_SEARCH_BASE: "ou=users,dc=mavenir,dc=com"
                    LDAP_GROUP_SEARCH_BASE: "ou=groups,dc=mavenir,dc=com"
                    LDAP_BIND_DN: "cn=bind,dc=mavenir,dc=com"
                    LDAP_AUTHTOK: "mavenir"
                    USER_GROUP1: "vDRA_Linux_Admin,3200,admin"
                    USER_GROUP2: "vDRA_Linux_User1,3201,nonadmin"
                    USER_GROUP3: "vDRA_Linux_User2,3202,nonadmin"
                    USER_GROUP4: "vDRA_Linux_User3,3203,nonadmin"
                    CA_CERT: |
                      -----BEGIN CERTIFICATE-----
                      MIICqTCCAhICCQCJ0x73PhzBGjANBgkqhkiG9w0BAQUFADCBmDELMAkGA1UEBhMC
                      SU4xEjAQBgNVBAgMCUthcm5hdGFrYTESMBAGA1UEBwwJQmVuZ2Fsb3JlMRgwFgYD
                      VQQKDA9NYXZlbmlyIFN5c3RlbXMxDDAKBgNVBAsMA05GVjEYMBYGA1UEAwwPd3d3
                      Lm1hdmVuaXIuY29tMR8wHQYJKoZIhvcNAQkBFhByb290QG1hdmVuaXIuY29tMB4X
                      DTE3MTEwOTE5NDkyOFoXDTI3MTEwNzE5NDkyOFowgZgxCzAJBgNVBAYTAklOMRIw
                      EAYDVQQIDAlLYXJuYXRha2ExEjAQBgNVBAcMCUJlbmdhbG9yZTEYMBYGA1UECgwP
                      TWF2ZW5pciBTeXN0ZW1zMQwwCgYDVQQLDANORlYxGDAWBgNVBAMMD3d3dy5tYXZl
                      bmlyLmNvbTEfMB0GCSqGSIb3DQEJARYQcm9vdEBtYXZlbmlyLmNvbTCBnzANBgkq
                      hkiG9w0BAQEFAAOBjQAwgYkCgYEAvcCZOa9PrGLRV7eA6Ilj9khTkP5+IAIn23B0
                      Z0l9vUDYdK0uzGpRKFaRGabS79dlr1VnWoLnEy1OiL5MbpYc6bt+2Q5sFaJfBLum
                      YFB0HMSNzOHsrAJwEPS/FiQOsnjOXp93EeW8UZcfOkmP/sdTjQOIhWRfb+IzGsJc
                      XKYbGacCAwEAATANBgkqhkiG9w0BAQUFAAOBgQARz8TPU08YAjYKgWGF1gJ5j+sL
                      l3TPoMJiPOKYQ5Sai5Zw+s+OP+zd/2s6W4uAa+BTdWDRaulWR9f1ZpImIyMLtT0c
                      fVdZM97anSpwIHq3noMzQlyzzawx/iDUK9PdyLnpIutwIhHLoQUpgT6gt1bBTpfw
                      liNKxRnrbS6AVblq+Q==
                      -----END CERTIFICATE-----
                runcmd: |
                  #!/bin/bash
                  set -x
                  exec > /var/log/user_data.log 2>&1
                  hostnamectl set-hostname HOSTNAME.mavenir.com
                  echo "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4" > /etc/hosts
                  echo "::1         localhost localhost.localdomain localhost6 localhost6.localdomain6" >> /etc/hosts
                  echo "$OAMIP  HOSTNAME HOSTNAME.mavenir.com" >> /etc/hosts
                  echo "ipv4=$OAMIP" > /opt/dist/cmsip.properties
                  #echo "ipv6=$OAMIPv6" >> /opt/dist/cmsip.properties
                  #rngd --rng-device=/dev/random
                  [ $DBIP == CMS_DB_STANDBY ] && sed -i 's/server-id=1/server-id=2/' /etc/my.cnf
                  [ $DBIP == CMS_DB_STANDBY ] && sed -i 's/1-relay-bin/2-relay-bin/g' /etc/my.cnf
                  [ $DBIP == CMS_DB_STANDBY ] && sed -i 's/1-mysql-bin/2-mysql-bin/g' /etc/my.cnf
 
                  if [ $Authentication == false ];then
                     #/usr/sbin/useradd confd_user
                     #echo confd_user_passwd|passwd --stdin confd_user
                     mkdir -p /home/confd_user/.ssh/
                     \cp -Rf /home/admin/.ssh/* /home/confd_user/.ssh/
                     chown -R confd_user.confd_user /home/confd_user/.ssh/
                     sed -i "/\/home\/admin/s/\/bin\/bash/\/sbin\/nologin/g" /etc/passwd
                     #sed -i "/\/home\/confd_user/s/\/bin\/bash/\/sbin\/nologin/g" /etc/passwd

                     sed -i -e "s/cmsConfd.netConf.username.*/cmsConfd.netConf.username=confd_user/g" -e "s/cmsConfd.netConf.password.*/cmsConfd.netConf.password=confd_user_passwd/g" /opt/dist/WebController/conf/application.properties
                     sed -i -e "s/confd.username.*/confd.username=confd_user/g" /opt/dist/ProcessMonitor/conf/application.properties
                     sed -i -e "s/confd.pemFile=.*/confd.pemFile=\/home\/confd_user\/.ssh\/id_rsa/g" /opt/dist/NetConfManager/conf/application.properties
                     sed -i -e "s/confd.mOne.remoteuser.*/confd.mOne.remoteuser=confd_user/g" -e "s/confd.dsc.remoteuser.*/confd.dsc.remoteuser=confd_user/g" -e "s/confd.vnfm.remoteuser.*/confd.vnfm.remoteuser=confd_user/g" -e "s/dsc.confd.user=.*/dsc.confd.user=confd_user/g" -e "s/dsc.confd.pwd=.*/dsc.confd.pwd=confd_user_passwd/g" -e "s/dscfe.confd.user=.*/dscfe.confd.user=confd_user/g" -e "s/dscfe.confd.pwd=.*/dscfe.confd.pwd=confd_user_passwd/g" -e "s/dscri.confd.user=.*/dscri.confd.user=confd_user/g" -e "s/dscri.confd.pwd=.*/dscri.confd.pwd=confd_user_passwd/g" -e "s/dscmo.confd.user=.*/dscmo.confd.user=confd_user/g" -e "s/dscmo.confd.pwd=.*/dscmo.confd.pwd=confd_user_passwd/g" -e "s/confd.mOne.userName=.*/confd.mOne.userName=confd_user/g" -e "s/confd.mOne.pasword=.*/confd.mOne.pasword=confd_user_passwd/g" /opt/dist/NetConfManager/conf/application.properties

                     sed -i -e '/<authentication>/,/<\/authentication>/d' -e '/<groups>/,/<\/groups>/d' /opt/confd/var/confd/cdb/aaa_init.xml
                     sed -i '/<sshServerKeyDir>\/opt\/confd\/etc\/confd\/ssh<\/sshServerKeyDir>/a \
                       <authOrder>pam</authOrder>\
                      ' /opt/confd/etc/confd/confd.conf
                     sed -i '/<write-default>permit<\/write-default>/a \
                       <groups>\
                          <group>\
                          <name>admin</name>\
                          <user-name>confd_user</user-name>\
                          <user-name>private</user-name>\
                       </group>\
                       </groups>\
                       ' /opt/confd/var/confd/cdb/aaa_init.xml
                     sed -i -e "/<localAuthentication>/,/<\/localAuthentication>/s/<enabled>true<\/enabled>/<enabled>false<\/enabled>/g" /opt/confd/etc/confd/confd.conf
                     sed -i '/<\/aaa>/i \
                        <externalAuthentication> \
                          <enabled>false</enabled> \
                        </externalAuthentication> \
                     ' /opt/confd/etc/confd/confd.conf
                  fi

                  sed -i "s/confd.mOne.keybasedConnection=.*/confd.mOne.keybasedConnection=Confd_mOne/g" /opt/dist/NetConfManager/conf/application.properties
                  sed -i "s/confd.dsc.keybasedConnection=.*/confd.dsc.keybasedConnection=Confd_dsc/g" /opt/dist/NetConfManager/conf/application.properties
                  sed -i "s/confd.vnfm.keybasedConnection=.*/confd.vnfm.keybasedConnection=Confd_vnfm/g" /opt/dist/NetConfManager/conf/application.properties
                  sed -i "s/ha.enabled.*/ha.enabled=ha_enabled/g" /opt/dist/ProcessMonitor/conf/application.properties
                  sed -i "s/cms.ha.enable.*/cms.ha.enable=ha_enabled/g" /opt/dist/WebController/conf/application.properties

                  source /home/dbpasswd
                  service mysql status
                  if [ $? -eq 0 ];then
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* TO 'root'@'%' IDENTIFIED BY '$DBPASS' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* TO 'root'@'localhost' IDENTIFIED BY '$DBPASS' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* to 'controlDb'@'localhost' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* to 'controlDb'@'%' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT REPLICATION SLAVE ON *.* to 'repl'@'%' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT REPLICATION SLAVE ON *.* to 'repl'@'localhost' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     #mysql -v -ucontrolDb -pmavenir -e "GRANT ALL ON *.* TO 'controlDb'@'$DBIP' IDENTIFIED BY 'mavenir';flush privileges;"
                  else
                     /bin/systemctl start mysql.service
                     sleep 5
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* TO 'root'@'%' IDENTIFIED BY '$DBPASS' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* TO 'root'@'localhost' IDENTIFIED BY '$DBPASS' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* to 'controlDb'@'localhost' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT ALL ON *.* to 'controlDb'@'%' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT REPLICATION SLAVE ON *.* to 'repl'@'%' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     mysql -v -uroot -p$DBPASS -e "GRANT REPLICATION SLAVE ON *.* to 'repl'@'localhost' IDENTIFIED BY 'mavenir' WITH GRANT OPTION;flush privileges;"
                     #mysql -v -ucontrolDb -pmavenir -e "GRANT ALL ON *.* TO 'controlDb'@'$DBIP' IDENTIFIED BY 'mavenir';flush privileges;"
                  fi
                  sed -i "s|management.address:.*|management.address: $DBIP|g" /opt/dist/ProcessMonitor/conf/application.properties
                  sed -i "s|server.address:.*|server.address: $DBIP|g" /opt/dist/ProcessMonitor/conf/application.properties

                  sed -i -e "$ a\100 mytable" -e "$ a\101 mytable1" -e "$ a\102 mytable2" /etc/iproute2/rt_tables
                  \cp -f /home/route-* /home/rule-* /etc/sysconfig/network-scripts
                  sed -i "s/_OAM_GW_/$OAMGW/g" /etc/sysconfig/network-scripts/route-eth1
                  sed -i -e "s/_DB_IP_/$DBIP/g" -e "s/_DB_PF_/$DBPF/g" /etc/sysconfig/network-scripts/rule-eth1
                  sed -i "s/_OAM_GW_/$OAMGW/g" /etc/sysconfig/network-scripts/route-eth2
                  sed -i -e "s/_VNF_IP_/$VNFIP/g" -e "s/_VNF_PF_/$VNFPF/g" /etc/sysconfig/network-scripts/rule-eth2
                  sed -i "s/_OAM_GW_/$OAMGW/g" /etc/sysconfig/network-scripts/route-eth3
                  sed -i -e "s/_VNFM_IP_/$VNFMIP/g" -e "s/_VNFM_PF_/$VNFMPF/g" /etc/sysconfig/network-scripts/rule-eth3

                  sed -i "s/<OAM_IP>/$OAMIP/g" /opt/tomcat_latest/conf/server.xml
                  sed -i "/\[MYSQLD\]/a bind-address = $DBIP" /etc/my.cnf

                  cd /opt/dist

                  files="LIManager/conf/application.properties,NetConfManager/conf/application.properties,OamManager/conf/application.properties,RuleEngine/conf/application.properties,ToolsManager/conf/application.properties,WebController/conf/application.properties,ProcessMonitor/conf/application.properties"
                  IFS=, paths=($files)
                  for (( i=0; i<${#paths[@]}; i++ ));do
                      if [ $i -eq 6 ];then
                         sed -i -e "s/localhost:3306/$DBIP:3306/g" ${paths[$i]}
                      else
                         sed -i -e "s/localhost:3306/$DBIP:3306/g" -e "s/processmonitor.ip .*/processmonitor.ip = $DBIP/g" ${paths[$i]}
                      fi
                  done

                  python /opt/dist/ProcessMonitor/conf/configure_cms_state.py CMS_DB_ACTIVE CMS_DB_STANDBY

                  \cp -f /opt/dist/ProcessMonitor/conf/configure_cms_state.py /tmp
                  sed -i "s/ip_address/oam_ip_address/g" /tmp/configure_cms_state.py
                  python /tmp/configure_cms_state.py CMS_OAM_ACTIVE CMS_OAM_STANDBY

                  if [ $ROOT_LOGIN_DISABLED == true ];then
                      sed -i "s/PermitRootLogin.*/PermitRootLogin no/g" /etc/ssh/sshd_config
                  elif [ $ROOT_LOGIN_DISABLED == false ];then
                      sed -i "s/PermitRootLogin.*/PermitRootLogin yes/g" /etc/ssh/sshd_config
                  fi

                  chkconfig cms on
                  #service cms restart 
                  chkconfig cfginit off
                  sleep 10
                  #\rm -rf /home/dbpasswd
                  sync;sync;shutdown -r +1

           params:
              $OAMIP:  { get_attr: [CMS_1_oam_net_0_port, fixed_ips, 0, ip_address] }
              $OAMGW:  { get_attr: [CMS_1_oam_net_0_port, subnets, 0, gateway_ip] }
              $OAMPF: { list_join: [ '', [ {get_attr: [CMS_1_oam_net_0_port, subnets, 0, cidr, -2]}, {get_attr: [CMS_1_oam_net_0_port, subnets, 0, cidr, -1]} ] ] }

              $DBIP:  { get_attr: [CMS_1_db_net_1_port, fixed_ips, 0, ip_address] }
              $DBGW:  { get_attr: [CMS_1_db_net_1_port, subnets, 0, gateway_ip] }
              $DBPF: { list_join: [ '', [ {get_attr: [CMS_1_db_net_1_port, subnets, 0, cidr, -2]}, {get_attr: [CMS_1_db_net_1_port, subnets, 0, cidr, -1]} ] ] }

              $VNFIP:  { get_attr: [CMS_1_vnf_net_2_port, fixed_ips, 0, ip_address] }
              $VNFGW:  { get_attr: [CMS_1_vnf_net_2_port, subnets, 0, gateway_ip] }
              $VNFPF: { list_join: [ '', [ {get_attr: [CMS_1_vnf_net_2_port, subnets, 0, cidr, -2]}, {get_attr: [CMS_1_vnf_net_2_port, subnets, 0, cidr, -1]} ] ] }

              $VNFMIP:  { get_attr: [CMS_1_vnfm_net_3_port, fixed_ips, 0, ip_address] }
              $VNFMGW:  { get_attr: [CMS_1_vnfm_net_3_port, subnets, 0, gateway_ip] }
              $VNFMPF: { list_join: [ '', [ {get_attr: [CMS_1_vnfm_net_3_port, subnets, 0, cidr, -2]}, {get_attr: [CMS_1_vnfm_net_3_port, subnets, 0, cidr, -1]} ] ] }

              HOSTNAME: {get_param: [CMS_names, 0] }
              Confd_mOne: { get_param: Confd_mOne_KeybasedConnection }
              Confd_dsc: { get_param: Confd_dsc_KeybasedConnection }
              Confd_vnfm: { get_param: Confd_vnfm_KeybasedConnection }
              confd_user: { get_param: confd_user}
              confd_user_passwd: { get_param: confd_user_passwd}
              $Authentication: { get_param: localAuthentication}
              $ROOT_LOGIN_DISABLED: { get_param: ROOT_LOGIN_DISABLED}
              ha_enabled: { get_param: Ha_Enabled }
              CMS_DB_ACTIVE: {get_param: [CMS_DB_Active_Stadby_IPs, 0]}
              CMS_DB_STANDBY: {get_param: [CMS_DB_Active_Stadby_IPs, 1]}
              CMS_OAM_ACTIVE: {get_param: [CMS_OAM_Active_Stadby_IPs, 0]}
              CMS_OAM_STANDBY: {get_param: [CMS_OAM_Active_Stadby_IPs, 1]}


