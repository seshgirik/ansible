- include_tasks: ./update_descriptors_main.yml
- name: "Delete old host"
  shell: "rm -rf ~/.ssh/known_hosts"
  delegate_to: localhost
  args:
    warn: false
- include_tasks: setup_pwdless_login.yml
- include_tasks: vnfd_image_save_onboard.yml
- include_tasks: ./Descriptor_Save_Quick.yml
- include_tasks: ./Descriptor_Onboard_Quick.yml
- include_tasks: Config_Model_And_Data_Rolling.yml
- include_tasks: rolling_offline_config.yml
- include_tasks: pre_prod_upgrade.yml

- set_fact:
    QUERY_BUILDER: ""
    ORDER_BUILDER: ""

# - set_fact:
#     QUERY_BUILDER: "{{QUERY_BUILDER}} OR (vnfd_id='{{item.key}}' AND vnfdversion='{{item.value[\"NEW_VERSION\"]}}' AND NOT (operational_state='InstantiatedConfiguredActive' OR operational_state='InstantiatedConfiguredActiveMnt'))"
#   with_dict: "{{VNFD_UPGRADE_PARAMS}}"
#
# - set_fact:
#     QUERY_BUILDER: "{{QUERY_BUILDER[3:]}}"

- command: "mysql -u{{ MYSQL_USER }} -p{{ MYSQL_PASSWD }} {{ MYSQL_DB }} -sN -e \"select count(status) from rolling_upgrade where (status='PROCESSING' OR status='FAILED') AND src_ns_version='{{NSD_VERSION}}' AND target_ns_version='{{NEW_NSD_VERSION}}'\""
  register: STATUS_RESP
  remote_user: "{{CMS_IP_SYSUSER}}"
  retries: "{{DESCRIPTOR_RETRIES}}"
  delay: "{{ DELAY }}"
  until: STATUS_RESP.stdout_lines.0 == "0"
  ignore_errors: yes

- fail:
    msg:
    - ""
    - ""
    - "################################################################"
    - "################################################################"
    - "###                                                          ###"
    - "###                                                          ###"
    - "###                                                          ###"
    - "###                 ROLLING UPGRADE FAILED                   ###"
    - "###                                                          ###"
    - "###                                                          ###"
    - "###                                                          ###"
    - "################################################################"
    - "################################################################"
    - ""
    - ""
  when: STATUS_RESP.stdout_lines.0 != "0"

- debug:
    msg:
    - ""
    - ""
    - "################################################################"
    - "################################################################"
    - "###                                                          ###"
    - "###                                                          ###"
    - "###                                                          ###"
    - "###           PREPRODUCTION UPGRADE WAS SUCCESSFUL           ###"
    - "###               PRESS ENTER TO ACTIVATE FOA                ###"
    - "###                                                          ###"
    - "###                                                          ###"
    - "###                                                          ###"
    - "################################################################"
    - "################################################################"
    - ""
    - ""
  when: STATUS_RESP.stdout_lines.0 == "0"

- pause:

- include_tasks: pre_prod_activate_foa.yml
  when: STATUS_RESP.stdout_lines.0 == "0"
